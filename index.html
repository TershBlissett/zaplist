// After listCalendars(); inside handleAuthClick
listCalendars().then(fetchCalendarEvents);

// Add this new function below listCalendars
async function fetchCalendarEvents() {
  const calendarId = document.getElementById('calendarSelect').value;
  const now = new Date().toISOString();
  const endOfDay = new Date();
  endOfDay.setHours(23, 59, 59, 999);
  const end = endOfDay.toISOString();

  const response = await gapi.client.calendar.events.list({
    calendarId,
    timeMin: now,
    timeMax: end,
    showDeleted: false,
    singleEvents: true,
    orderBy: 'startTime'
  });

  const events = response.result.items || [];
  const tasks = getTasks();

  events.forEach(event => {
    if (!tasks.find(t => t.text === event.summary)) {
      const dueDate = event.start.dateTime?.split('T')[0] || '';
      const dueTime = event.start.dateTime?.split('T')[1]?.substring(0,5) || '';
      tasks.push({
        text: event.summary + ' ðŸ“…',
        dueDate,
        dueTime,
        done: false,
        calendarId,
        calendarName: document.getElementById('calendarSelect').selectedOptions[0].text
      });
    }
  });

  saveTasks(tasks);
  renderTasks();
}
