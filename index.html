// After listCalendars(); inside handleAuthClick
listCalendars().then(fetchCalendarEvents);

// Modified fetchCalendarEvents to mark existing events
async function fetchCalendarEvents() {
  const calendarId = document.getElementById('calendarSelect').value;
  const now = new Date().toISOString();
  const endOfDay = new Date();
  endOfDay.setHours(23, 59, 59, 999);
  const end = endOfDay.toISOString();

  const response = await gapi.client.calendar.events.list({
    calendarId,
    timeMin: now,
    timeMax: end,
    showDeleted: false,
    singleEvents: true,
    orderBy: 'startTime'
  });

  const events = response.result.items || [];
  const tasks = getTasks();

  events.forEach(event => {
    if (!tasks.find(t => t.text === event.summary)) {
      const dueDate = event.start.dateTime?.split('T')[0] || '';
      const dueTime = event.start.dateTime?.split('T')[1]?.substring(0,5) || '';
      tasks.push({
        text: event.summary + ' ðŸ“…',
        dueDate,
        dueTime,
        done: false,
        calendarId,
        calendarName: document.getElementById('calendarSelect').selectedOptions[0].text,
        fromCalendar: true
      });
    }
  });

  saveTasks(tasks);
  renderTasks();
}

// Add to createTask function: Push to Google Calendar if not fromCalendar
async function createTask() {
  const calendarId = document.getElementById('calendarSelect').value;
  const calendarName = document.getElementById('calendarSelect').selectedOptions[0].text;
  const taskInput = document.getElementById('taskInput');
  const dateInput = document.getElementById('dueDate');
  const timeInput = document.getElementById('dueTime');

  const text = taskInput.value.trim();
  const dueDate = dateInput.value;
  const dueTime = timeInput.value;
  if (!text) return;

  const task = {
    text,
    dueDate,
    dueTime,
    done: false,
    calendarId,
    calendarName
  };

  const tasks = getTasks();
  tasks.push(task);
  saveTasks(tasks);
  renderTasks();

  taskInput.value = '';
  dateInput.value = '';
  timeInput.value = '';

  if (gapi.client && dueDate && dueTime) {
    const startDateTime = new Date(`${dueDate}T${dueTime}:00`);
    const endDateTime = new Date(startDateTime.getTime() + 30 * 60000);

    await gapi.client.calendar.events.insert({
      calendarId,
      resource: {
        summary: text,
        start: { dateTime: startDateTime.toISOString() },
        end: { dateTime: endDateTime.toISOString() }
      }
    });
  }
}
